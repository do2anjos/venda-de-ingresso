using Microsoft.AspNetCore.Mvc;using Microsoft.EntityFrameworkCore;using VendaDeIngresso.Api.Data;using VendaDeIngresso.Api.Models;namespace VendaDeIngresso.Api.Controllers;[ApiController][Route("api/venda")]public class VendaController : ControllerBase{    private readonly CinemaContext _context;    public VendaController(CinemaContext context)    {        _context = context;    }    [HttpPost("{assentoId}")]    public async Task<IActionResult> ConfirmarVenda(int assentoId, [FromBody] VendaRequest request)    {        var agora = DateTime.UtcNow;        var assento = await _context.Assento.FindAsync(assentoId);        if (assento == null)            return NotFound("Assento não existe.");        var vendaExistente = await _context.Venda            .AnyAsync(v => v.AssentoId == assentoId);        if (vendaExistente)            return BadRequest("Assento já foi vendido.");        var reserva = await _context.Reserva            .FirstOrDefaultAsync(r => r.AssentoId == assentoId);        if (reserva != null)        {            if (reserva.DataExpiracao > agora)            {                if (reserva.UsuarioId != request.UsuarioId)                {                    return BadRequest("Este assento está reservado por outro usuário.");                }            }            _context.Reserva.Remove(reserva);        }        var vizinhoOcupado = await _context.Venda            .Include(v => v.Assento)            .AnyAsync(v =>                v.Assento.Linha == assento.Linha &&                (v.Assento.Coluna == assento.Coluna - 1 || v.Assento.Coluna == assento.Coluna + 1));        if (vizinhoOcupado)        {            return BadRequest("Regra de distanciamento: Não é permitido comprar um assento ao lado de outro já ocupado.");        }        var venda = new Venda        {            AssentoId = assentoId,            UsuarioId = request.UsuarioId,            DataVenda = agora,            Valor = request.Valor        };        _context.Venda.Add(venda);        await _context.SaveChangesAsync();        return Ok(new        {            mensagem = "Venda confirmada com sucesso!",            vendaId = venda.VendaId,            assento = new { assento.Linha, assento.Coluna }        });    }    [HttpGet]    public async Task<IActionResult> ListarVendas()    {        var vendas = await _context.Venda            .Include(v => v.Assento)            .Select(v => new            {                v.VendaId,                v.UsuarioId,                v.DataVenda,                v.Valor,                Assento = new                {                    v.Assento.AssentoId,                    v.Assento.Linha,                    v.Assento.Coluna                }            })            .ToListAsync();        return Ok(vendas);    }    [HttpPost("lote")]    public async Task<IActionResult> ConfirmarVendaLote([FromBody] VendaLoteRequest request)    {        var agora = DateTime.UtcNow;        if (request.AssentoIds == null || !request.AssentoIds.Any())            return BadRequest("Nenhum assento selecionado.");        var assentos = await _context.Assento            .Where(a => request.AssentoIds.Contains(a.AssentoId))            .ToListAsync();        if (assentos.Count != request.AssentoIds.Count)            return BadRequest("Um ou mais assentos selecionados não existem.");        foreach (var a in assentos)        {            if (await _context.Venda.AnyAsync(v => v.AssentoId == a.AssentoId))                return BadRequest($"O assento (L:{a.Linha}, C:{a.Coluna}) já foi vendido.");            var reserva = await _context.Reserva.FirstOrDefaultAsync(r => r.AssentoId == a.AssentoId);            if (reserva != null && reserva.DataExpiracao > agora && reserva.UsuarioId != request.UsuarioId)                return BadRequest($"O assento (L:{a.Linha}, C:{a.Coluna}) está reservado por outro usuário.");        }        foreach (var a in assentos)        {            var vizinhoOcupado = await _context.Venda                .Include(v => v.Assento)                .AnyAsync(v =>                    v.Assento.Linha == a.Linha &&                    (v.Assento.Coluna == a.Coluna - 1 || v.Assento.Coluna == a.Coluna + 1) &&                    !request.AssentoIds.Contains(v.AssentoId));             if (vizinhoOcupado)            {                return BadRequest($"Regra de distanciamento: O assento (L:{a.Linha}, C:{a.Coluna}) está ao lado de um já ocupado por outra venda.");            }        }        using var transaction = await _context.Database.BeginTransactionAsync();        try        {            foreach (var a in assentos)            {                var reserva = await _context.Reserva.FirstOrDefaultAsync(r => r.AssentoId == a.AssentoId);                if (reserva != null) _context.Reserva.Remove(reserva);                _context.Venda.Add(new Venda                {                    AssentoId = a.AssentoId,                    UsuarioId = request.UsuarioId,                    DataVenda = agora,                    Valor = request.ValorTotal / assentos.Count                 });            }            await _context.SaveChangesAsync();            await transaction.CommitAsync();        }        catch (Exception ex)        {            await transaction.RollbackAsync();            return StatusCode(500, $"Erro ao processar venda em lote: {ex.Message}");        }        return Ok(new { mensagem = "Venda em lote confirmada com sucesso!", totalAssentos = assentos.Count });    }}public class VendaRequest{    public required string UsuarioId { get; set; }    public decimal Valor { get; set; }}public class VendaLoteRequest{    public required string UsuarioId { get; set; }    public required List<int> AssentoIds { get; set; }    public decimal ValorTotal { get; set; }}