using Microsoft.AspNetCore.Mvc;using Microsoft.EntityFrameworkCore;using VendaDeIngresso.Api.Data;using VendaDeIngresso.Api.Models;namespace VendaDeIngresso.Api.Controllers;[ApiController][Route("api/assento")]public class AssentoController : ControllerBase{    private readonly CinemaContext _context;    public AssentoController(CinemaContext context)    {        _context = context;    }    [HttpGet]    public async Task<IActionResult> Get()    {        var agora = DateTime.UtcNow;        var assentos = await _context.Assento            .Select(a => new            {                a.AssentoId,                a.Linha,                a.Coluna,                Status =                    _context.Venda.Any(v => v.AssentoId == a.AssentoId) ? "Ocupado" :                    _context.Reserva.Any(r => r.AssentoId == a.AssentoId && r.DataExpiracao > agora) ? "Reservado" :                    "Livre"            })            .ToListAsync();        return Ok(assentos);    }    [HttpGet("mapa")]    public async Task<IActionResult> ObterMapa()    {        var assentos = await _context.Assento.ToListAsync();        var vendas = await _context.Venda.ToListAsync();        var reservas = await _context.Reserva            .Where(r => r.DataExpiracao > DateTime.UtcNow)             .ToListAsync();        var mapa = assentos.Select(a =>        {            int status = 0;             string? donoId = null;            var venda = vendas.FirstOrDefault(v => v.AssentoId == a.AssentoId);            if (venda != null)            {                status = 2;                 donoId = venda.UsuarioId;            }            else            {                var reserva = reservas.FirstOrDefault(r => r.AssentoId == a.AssentoId);                if (reserva != null)                {                    status = 1;                     donoId = reserva.UsuarioId;                }            }            return new            {                a.AssentoId,                a.Linha,                a.Coluna,                Status = status,                 UsuarioId = donoId            };        });        return Ok(mapa);    }    [HttpPost]    public async Task<IActionResult> CriarAssento([FromBody] Assento assento)    {        if (assento.SalaId == 0) assento.SalaId = 1;        _context.Assento.Add(assento);        await _context.SaveChangesAsync();        return Ok(assento);    }    [HttpPost("seed")]    public async Task<IActionResult> Seed()    {        var sala = await _context.Sala.FindAsync(1);        if (sala == null)        {            sala = new Sala { Nome = "Sala 1 IMAX", TotalLinhas = 10, TotalColunas = 10 };            _context.Sala.Add(sala);            await _context.SaveChangesAsync();        }        if (!await _context.Assento.AnyAsync())        {            var listaAssentos = new List<Assento>();            for (int l = 1; l <= sala.TotalLinhas; l++)            {                for (int c = 1; c <= sala.TotalColunas; c++)                {                    listaAssentos.Add(new Assento { SalaId = sala.SalaId, Linha = l, Coluna = c });                }            }            _context.Assento.AddRange(listaAssentos);            await _context.SaveChangesAsync();            return Ok(new { mensagem = $"Banco populado com Sala 1 e {listaAssentos.Count} assentos (Completo)." });        }        return Ok(new { mensagem = "Banco jÃ¡ estava populado." });    }    [HttpDelete("reset")]    public async Task<IActionResult> Reset()    {        var vendas = await _context.Venda.ToListAsync();        var reservas = await _context.Reserva.ToListAsync();        _context.Venda.RemoveRange(vendas);        _context.Reserva.RemoveRange(reservas);        await _context.SaveChangesAsync();        return Ok(new { mensagem = "Dados de venda e reserva limpos com sucesso." });    }}