import { Component, OnInit, OnDestroy, signal, computed, inject } from '@angular/core';import { CommonModule } from '@angular/common';import { RouterLink } from '@angular/router';import { CinemaService } from '../../services/cinema.service';import { Assento } from '../../models/cinema.models';@Component({    selector: 'app-reserva',    standalone: true,    imports: [CommonModule, RouterLink],    templateUrl: './reserva.component.html',    styleUrl: './reserva.component.css'})export class ReservaComponent implements OnInit, OnDestroy {    private cinemaService = inject(CinemaService);    assentos = signal<Assento[]>([]);    selecionados = signal<Assento[]>([]);    timerSeconds = signal(0);    loading = signal(true);    error = signal<string | null>(null);    successMessage = signal<string | null>(null);    readonly usuarioId = 'usuario-' + Math.random().toString(36).substring(7);    readonly valorPorAssento = 25.00;    private timerInterval: any;    totalValor = computed(() => this.selecionados().length * this.valorPorAssento);    podeComprar = computed(() => this.selecionados().length > 0 && this.timerSeconds() > 0);    rows = computed(() => {        const todos = this.assentos();        if (todos.length === 0) return [];        const grupos: { letra: string, assentos: Assento[] }[] = [];        for (let i = 1; i <= 10; i++) {            const assentosLinha = todos                .filter(a => a.linha === i)                .sort((a, b) => a.coluna - b.coluna);            if (assentosLinha.length > 0) {                grupos.push({                    letra: String.fromCharCode(64 + i),                     assentos: assentosLinha                });            }        }        return grupos;    });    ngOnInit() {        this.carregarMapa();    }    ngOnDestroy() {        this.pararTimer();    }    carregarMapa() {        this.loading.set(true);        this.error.set(null);        this.cinemaService.getMapa().subscribe({            next: (data) => {                this.assentos.set(data);                this.loading.set(false);            },            error: (err) => {                this.error.set('Erro ao carregar mapa. Verifique se o servidor estÃ¡ rodando.');                this.loading.set(false);                console.error(err);            }        });    }    getAssentoClass(assento: Assento): string {        const ehMeu = this.selecionados().some(s => s.assentoId === assento.assentoId) ||            (assento.status === 1 && assento.usuarioId === this.usuarioId);        if (ehMeu) return 'assento selecionado';         if (assento.status === 2) return 'assento vendido';         if (assento.status === 1) return 'assento reservado';         return 'assento disponivel';     }    selecionarAssento(assento: Assento) {        if (assento.status === 2) return;        if (assento.status === 1 && assento.usuarioId !== this.usuarioId) return;        const ehMeu = this.selecionados().some(s => s.assentoId === assento.assentoId) ||            (assento.status === 1 && assento.usuarioId === this.usuarioId);        if (ehMeu) {            this.cinemaService.cancelarReserva(assento.assentoId, this.usuarioId).subscribe({                next: () => {                    this.selecionados.update(arr => arr.filter(s => s.assentoId !== assento.assentoId));                    if (this.selecionados().length === 0) {                        this.pararTimer();                    }                    this.carregarMapa();                },                error: (err) => console.error('Erro ao cancelar reserva', err)            });        } else {            this.reservarAssento(assento);        }    }    private reservarAssento(assento: Assento) {        this.cinemaService.reservar(assento.assentoId, this.usuarioId).subscribe({            next: () => {                this.selecionados.update(arr => [...arr, assento]);                this.iniciarTimer();                this.carregarMapa();            },            error: (err) => {                const msg = err.error || 'Erro ao reservar assento';                this.error.set(typeof msg === 'string' ? msg : JSON.stringify(msg));                setTimeout(() => this.error.set(null), 3000);            }        });    }    private iniciarTimer() {        this.pararTimer();        this.timerSeconds.set(120);         this.timerInterval = setInterval(() => {            this.timerSeconds.update(t => {                if (t <= 1) {                    this.pararTimer();                    this.selecionados.set([]);                    this.carregarMapa();                    return 0;                }                return t - 1;            });        }, 1000);    }    private pararTimer() {        if (this.timerInterval) {            clearInterval(this.timerInterval);            this.timerInterval = null;        }    }    formatTimer(): string {        const mins = Math.floor(this.timerSeconds() / 60);        const secs = this.timerSeconds() % 60;        return `${mins}:${secs.toString().padStart(2, '0')}`;    }    finalizarCompra() {        if (!this.podeComprar()) return;        const ids = this.selecionados().map(s => s.assentoId);        if (ids.length === 1) {            this.cinemaService.confirmarVenda(ids[0], {                usuarioId: this.usuarioId,                valor: this.valorPorAssento            }).subscribe({                next: (res) => {                    this.successMessage.set(res.mensagem);                    this.pararTimer();                    this.selecionados.set([]);                    this.carregarMapa();                    setTimeout(() => this.successMessage.set(null), 3000);                },                error: (err) => {                    const msg = err.error || 'Erro ao confirmar venda';                    this.error.set(typeof msg === 'string' ? msg : JSON.stringify(msg));                    setTimeout(() => this.error.set(null), 3000);                }            });        } else {            this.cinemaService.confirmarVendaLote({                usuarioId: this.usuarioId,                assentoIds: ids,                valorTotal: this.totalValor()            }).subscribe({                next: (res) => {                    this.successMessage.set(res.mensagem);                    this.pararTimer();                    this.selecionados.set([]);                    this.carregarMapa();                    setTimeout(() => this.successMessage.set(null), 3000);                },                error: (err) => {                    const msg = err.error || 'Erro ao confirmar venda em lote';                    this.error.set(typeof msg === 'string' ? msg : JSON.stringify(msg));                    setTimeout(() => this.error.set(null), 3000);                }            });        }    }}